<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FATURA IME PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* LIGHT THEME DEFINITIONS */
        body.light-theme {
            background-color: #f8fafc; /* Ngjyrë e hapur Slate */
            color: #1e293b;
        }

        body.light-theme #main-app {
            background: #f1f5f9;
        }

        body.light-theme .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #1e293b;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body.light-theme .text-white {
            color: #0f172a !important;
        }

        body.light-theme .text-slate-400, 
        body.light-theme .text-slate-500 {
            color: #64748b !important;
        }

        body.light-theme #sidebar {
            background: rgba(255, 255, 255, 0.98);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* Korigjim për butonat në Light Mode */
        body.light-theme .ios-btn:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        :root { --accent: #6366f1; }
        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background: #000; 
            color: #fff;
            overflow-x: hidden; 
        }

        /* --- INTRO CINEMATIC --- */
        #intro-screen {
            position: fixed;
            inset: 0;
            z-index: 5000;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 1s ease;
        }
        .logo-box { position: relative; animation: initial-scale 2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .logo-text {
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: -2px;
            background: linear-gradient(to bottom, #ffffff 30%, #444444 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0;
            animation: text-reveal 1s 0.5s ease-out forwards;
            position: relative;
        }

        .light-sweep {
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg);
            animation: sweep 1.5s 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes initial-scale { from { transform: scale(1.2); filter: blur(10px); } to { transform: scale(1); filter: blur(0); } }
        @keyframes text-reveal { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes sweep { from { left: -100%; } to { left: 200%; } }

        /* --- FACE ID UI --- */
        #face-id-screen {
            position: fixed;
            inset: 0;
            z-index: 4000;
            background: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes scan-move {
            0% { top: 5%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 90%; opacity: 0; }
        }

        .scanning-active #scan-line {
            display: block;
            position: absolute;
            width: 100%;
            height: 2px;
            background: #6366f1;
            box-shadow: 0 0 15px #6366f1;
            animation: scan-move 2s ease-in-out infinite;
        }

        .scanning-active #scanner-wrapper {
            border-color: rgba(99, 102, 241, 0.3);
            transform: scale(1.05);
        }

        .auth-success #face-icon { color: #10b981; filter: drop-shadow(0 0 10px #10b981); }

        /* --- APP UI & OVERLAY --- */
        #menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        #menu-overlay.active { opacity: 1; pointer-events: auto; }

        .glass-panel {
            background: rgba(15, 15, 15, 0.7);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 32px;
        }
        
        .sidebar {
            transition: all 0.6s cubic-bezier(0.32, 0.72, 0, 1);
            transform: translateX(-100%);
            z-index: 1001;
        }
        .sidebar.open { transform: translateX(0); }

        .ios-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .ios-btn:active { transform: scale(0.9) brightness(1.2); }

        .cat-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .cat-card.selected {
            background: #fff !important;
            color: #000 !important;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 255, 255, 0.1);
        }

        #main-app {
            opacity: 0;
            transform: translateY(30px);
            transition: all 1s ease;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="antialiased">

    <div id="menu-overlay" onclick="toggleMenu()"></div>

    <div id="intro-screen">
        <div class="logo-box">
            <h1 class="logo-text italic">FATURAIME.</h1>
            <div class="light-sweep"></div>
        </div>
    </div>

    <div id="auth-overlay" class="fixed inset-0 z-[7000] bg-black flex items-center justify-center p-6 transition-all duration-1000">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute -top-[10%] -left-[10%] w-[50%] h-[50%] bg-indigo-600/20 blur-[120px] rounded-full animate-pulse"></div>
            <div class="absolute -bottom-[10%] -right-[10%] w-[50%] h-[50%] bg-purple-600/20 blur-[120px] rounded-full animate-pulse" style="animation-delay: 2s"></div>
        </div>

        <div class="relative w-full max-w-sm glass-panel p-10 text-center slide-up border-white/10 shadow-2xl">
            <div class="mb-10">
                <div class="w-20 h-20 bg-gradient-to-tr from-indigo-600 to-purple-500 rounded-[2rem] mx-auto flex items-center justify-center shadow-2xl mb-6 border-2 border-white/20">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
                <h2 id="auth-title" class="text-3xl font-bold tracking-tighter mb-2">Mirësevini</h2>
                <p class="text-[10px] opacity-50 font-medium uppercase tracking-widest">Shkruani emrin tuaj për të vazhduar</p>
            </div>

            <div class="space-y-4" id="auth-form">
                <input type="text" id="userNameInput" placeholder="Emri dhe Mbiemri" 
                    class="w-full bg-white/5 border border-white/10 text-white py-4 px-6 rounded-2xl font-bold outline-none focus:border-indigo-500 transition-all text-center">
                
                <button onclick="handleManualAuth()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold ios-btn shadow-lg shadow-indigo-600/20">
                    Hyni në Aplikacion
                </button>
            </div>
        </div>
    </div>

    <div id="sidebar" class="sidebar fixed inset-y-0 left-0 w-80 bg-[#0a0a0c]/98 backdrop-blur-2xl p-8 border-r border-white/5 z-[9000] shadow-2xl transition-all duration-500 transform -translate-x-full">
        <button onclick="toggleMenu()" class="absolute top-6 right-6 p-2 rounded-full bg-white/5 text-white/40 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2" stroke-linecap="round"/></svg>
        </button>

        <div class="mt-10 mb-12 flex flex-col items-center text-center">
            <div class="relative mb-4">
                <div class="w-24 h-24 rounded-[2rem] overflow-hidden border-2 border-indigo-500/30 p-1 bg-gradient-to-tr from-indigo-600/20 to-purple-600/20">
                    <img id="sidebarUserPhoto" src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff" class="w-full h-full object-cover rounded-[1.8rem]" alt="Profile">
                </div>
                <div class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 border-4 border-[#0a0a0c] rounded-full"></div>
            </div>
            <h2 id="sidebarUserName" class="text-xl font-bold text-white tracking-tight">Përdoruesi</h2>
            <p class="text-[10px] text-indigo-400 uppercase tracking-[0.2em] font-black mt-1">Premium Member</p>
        </div>

        <div class="mb-12 p-5 rounded-[2rem] bg-white/5 border border-white/5">
            <div class="flex justify-between items-end mb-2">
                <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Statusi i Limitit</span>
                <span id="sidebarLimitPercent" class="text-xs font-black text-indigo-400">0%</span>
            </div>
            <div class="w-full h-1.5 bg-white/5 rounded-full overflow-hidden">
                <div id="sidebarLimitBar" class="h-full bg-gradient-to-r from-indigo-600 to-purple-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
        </div>

        <div class="space-y-6">
            <h3 class="text-slate-500 font-bold text-[10px] uppercase tracking-[0.3em] ml-2">Menuja Kryesore</h3>
            <nav class="space-y-3">
                <button onclick="location.reload()" class="group w-full flex items-center gap-4 p-4 rounded-[1.5rem] transition-all duration-300 hover:bg-indigo-600/10 border border-transparent hover:border-indigo-500/20">
                    <div class="w-10 h-10 flex items-center justify-center rounded-2xl bg-indigo-500/10 text-indigo-500 group-hover:bg-indigo-500 group-hover:text-white transition-all">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2" stroke-width="2"/></svg>
                    </div>
                    <span class="font-bold text-sm text-slate-300 group-hover:text-white transition-colors">Dashboard</span>
                </button>
                </nav>
        </div>

        <div class="mt-8 p-4 rounded-2xl bg-white/5 border border-white/5">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="theme-icon-container" class="w-8 h-8 flex items-center justify-center rounded-lg bg-indigo-500/20 text-indigo-400">
                        <svg id="moon-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" stroke-width="2"/></svg>
                    </div>
                    <span class="text-[11px] font-bold text-slate-300 uppercase tracking-wider">Tema e dritës</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="theme-toggle" class="sr-only peer" onchange="toggleTheme()">
                    <div class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                </label>
            </div>
        </div>
    </div>

    <div id="main-app" class="max-w-md mx-auto min-h-screen px-6 pt-16 pb-24">
        <div class="flex justify-between items-center mb-12">
            <button onclick="toggleMenu()" class="ios-btn">
                <div class="w-8 h-1 bg-white mb-1.5 rounded-full"></div>
                <div class="w-5 h-1 bg-white rounded-full"></div>
            </button>
            <div class="text-right">
                <p id="userGreeting" class="font-bold text-sm">Mirësevini</p>
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Sistemi Gati</p>
            </div>
        </div>

        <div class="glass-panel p-10 mb-10 bg-gradient-to-br from-[#111] to-[#000] relative overflow-hidden">
            <div class="relative z-10">
                <span class="text-[10px] text-indigo-400 font-bold uppercase tracking-[0.3em]">Totali i Shpenzuar</span>
                <h2 id="mainBalance" class="text-6xl font-bold mt-2 tracking-tighter italic">0.00 €</h2>
                <div class="flex gap-10 mt-10">
                    <div>
                        <p class="text-[9px] text-slate-500 font-black uppercase mb-1">Limit</p>
                        <p id="limitText" class="font-bold">0 €</p>
                    </div>
                    <div>
                        <p class="text-[9px] text-slate-500 font-black uppercase mb-1">Mbetja</p>
                        <p id="remainingText" class="font-bold text-emerald-500">0 €</p>
                    </div>
                </div>
            </div>
            <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-600/10 blur-[60px]"></div>
        </div>

        <div class="mb-10 opacity-60">
            <canvas id="appChart" height="180"></canvas>
        </div>

        <div class="space-y-4" id="listContainer"></div>

        <button onclick="showAddModal()" class="fixed bottom-10 left-1/2 -translate-x-1/2 w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center shadow-[0_0_40px_rgba(99,102,241,0.4)] ios-btn z-40 border-4 border-black">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="3"/></svg>
        </button>
    </div>

    <div id="addModal" class="fixed inset-0 z-[2000] hidden flex items-end">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-xl" onclick="hideModal('addModal')"></div>
        <div class="relative w-full glass-panel rounded-t-[3rem] p-10 border-t border-white/10">
            <div class="w-12 h-1.5 bg-white/10 mx-auto mb-10 rounded-full"></div>
            <div class="text-center mb-10">
                <input type="number" id="inpAmount" placeholder="0.00" class="bg-transparent border-none text-center text-7xl font-bold outline-none w-full placeholder-white/5 italic text-white">
            </div>
            <button onclick="submitExpense()" class="w-full bg-white text-black p-6 rounded-2xl font-black text-lg mt-6 ios-btn uppercase">Konfirmo</button>
        </div>
    </div>


     <script>
/**
 * FATURA IME PRO - CORE ENGINE v4.5 (COMPLETE VERSION)
 */

// 1. KONFIGURIMI I IKONAVE
const iconMap = {
    food:   `<svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M21 7.5l-9-4.5-9 4.5M3 7.5v9l9 4.5 9-4.5v-9M12 3v18M3 7.5l9 4.5 9-4.5"/></svg>`,
    travel: `<svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>`,
    bill:   `<svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 11-7.6-11.7M16 5l3 3m0 0l3 3m-3-3l-3 3m3-3H9"/></svg>`,
    style:  `<svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M9 10V6a3 3 0 016 0v4M4.5 10h15l1 11H3.5l1-11z"/></svg>`,
    health: `<svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>`,
    assets: `<svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2"/></svg>`
};

// 2. STATE MANAGEMENT
const db = {
    expenses: JSON.parse(localStorage.getItem('f_pro_v3')) || [],
    limit: parseFloat(localStorage.getItem('f_pro_lim_v3')) || 0,
    userName: localStorage.getItem('f_pro_user_name') || "",
    userPhoto: localStorage.getItem('f_pro_user_photo') || null,
    charts: { line: null, donut: null }
};

// --- FUNKSIONI I RI SHTUES (URA LIDHESE) ---
function handleManualAuth() {
    const nameInput = document.getElementById('userNameInput');
    const name = nameInput.value.trim();
    const overlay = document.getElementById('auth-overlay');

    if (name === "") {
        alert("Ju lutem shkruani emrin tuaj!");
        return;
    }

    db.userName = name;
    localStorage.setItem('f_pro_user_name', name);
    
    // Përdorim logjikën tënde ekzistuese për të mbyllur overlay-n
    if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.remove();
            initApp(); // Thërret funksionin tënd origjinal
        }, 800);
    }
}

// 3. LIFECYCLE INITIALIZATION
window.addEventListener('load', () => {
    applySavedTheme();
    const intro = document.getElementById('intro-screen');
    
    setTimeout(() => {
        if (intro) {
            intro.style.opacity = '0';
            intro.style.pointerEvents = 'none';
            setTimeout(() => {
                intro.remove();
                handleNavigationFlow();
            }, 800);
        }
    }, 2200);
});

function handleNavigationFlow() {
    const authOverlay = document.getElementById('auth-overlay');
    if (db.userName && db.userName !== "") {
        if (document.getElementById('face-id-screen')) {
            startFaceID();
        } else {
            if (authOverlay) authOverlay.remove();
            initApp();
        }
    } else {
        if (authOverlay) authOverlay.classList.remove('hidden');
    }
}

// 4. AUTHENTICATION LOGIC (ORIGJINALE)
function completeAuth() {
    const nameInput = document.getElementById('userNameInput');
    const photoInput = document.getElementById('userPhotoInput');
    
    if (!nameInput.value.trim()) {
        alert("Ju lutem shkruani emrin tuaj!");
        return;
    }

    db.userName = nameInput.value.trim();
    localStorage.setItem('f_pro_user_name', db.userName);

    if (photoInput && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            db.userPhoto = e.target.result;
            localStorage.setItem('f_pro_user_photo', db.userPhoto);
            finishAuthFlow();
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finishAuthFlow();
    }
}

function finishAuthFlow() {
    const authOverlay = document.getElementById('auth-overlay');
    if (authOverlay) {
        authOverlay.style.opacity = '0';
        setTimeout(() => {
            authOverlay.remove();
            if (document.getElementById('face-id-screen')) startFaceID();
            else initApp();
        }, 500);
    }
}

// 5. FACE ID & INITIALIZATION
async function startFaceID() {
    const screen = document.getElementById('face-id-screen');
    const wrapper = document.getElementById('scanner-wrapper');
    const status = document.getElementById('auth-status');

    if (!screen) return initApp();

    screen.style.display = 'flex';
    wrapper.classList.add('scanning-active');
    status.innerText = "Duke verifikuar tiparet...";

    setTimeout(() => {
        wrapper.classList.remove('scanning-active');
        screen.classList.add('auth-success');
        status.innerText = "Identiteti u konfirmua";
        status.style.color = "#10b981";

        setTimeout(() => {
            screen.style.opacity = "0";
            screen.style.transform = "scale(1.1) translateY(-20px)";
            setTimeout(() => { screen.remove(); initApp(); }, 600);
        }, 1200);
    }, 2800);
}

function initApp() {
    const mainApp = document.getElementById('main-app');
    if (mainApp) {
        mainApp.style.display = 'block';
        setTimeout(() => {
            mainApp.style.opacity = '1';
            mainApp.style.transform = 'translateY(0)';
        }, 50);
    }
    
    if (db.userName) {
        const greeting = document.getElementById('userGreeting');
        if (greeting) greeting.innerText = `Përshëndetje, ${db.userName}`;
    }
    
    updateDashboardPhotos();
    initCharts();
    renderUI();
}

function updateDashboardPhotos() {
    const dashPhoto = document.getElementById('dashboardUserPhoto');
    const sidePhoto = document.getElementById('sidebarUserPhoto');
    if (dashPhoto && db.userPhoto) dashPhoto.src = db.userPhoto;
    if (sidePhoto && db.userPhoto) sidePhoto.src = db.userPhoto;
}

// 6. RENDERING ENGINE
function renderUI() {
    const total = db.expenses.reduce((s, a) => s + a.amount, 0);
    const remaining = db.limit - total;

    const bEl = document.getElementById('mainBalance');
    if (bEl) bEl.innerText = `${total.toFixed(2)} €`;
    
    const lEl = document.getElementById('limitText');
    if (lEl) lEl.innerText = `${db.limit.toFixed(2)} €`;

    const rEl = document.getElementById('remainingText');
    if (rEl) {
        rEl.innerText = `${remaining.toFixed(2)} €`;
        rEl.style.color = remaining < 0 ? '#ef4444' : '#10b981';
    }

    const container = document.getElementById('listContainer');
    if (container) {
        if (db.expenses.length === 0) {
            container.innerHTML = `<div class="py-12 text-center opacity-20 italic">Nuk ka të dhëna</div>`;
        } else {
            container.innerHTML = db.expenses.slice(0, 15).map(exp => `
                <div class="glass-panel p-5 flex justify-between items-center mb-4 transition-all hover:bg-white/5">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-indigo-500/10 rounded-2xl flex items-center justify-center">
                            ${iconMap[exp.icon] || iconMap.food}
                        </div>
                        <div>
                            <h4 class="font-bold text-[11px] uppercase text-white/90">${exp.cat}</h4>
                            <p class="text-[9px] opacity-40 font-medium">${exp.date}</p>
                        </div>
                    </div>
                    <span class="font-bold text-sm text-white">-${exp.amount.toFixed(2)} €</span>
                </div>
            `).join('');
        }
    }

    if (db.charts.line) {
        db.charts.line.data.datasets[0].data = db.expenses.slice(0, 6).map(e => e.amount).reverse();
        db.charts.line.update();
    }
    
    updateFinancialIntelligence();
    updateSidebarUI();
}

// 7. SIDEBAR & THEME
function updateSidebarUI() {
    const nameEl = document.getElementById('sidebarUserName');
    if (nameEl && db.userName) nameEl.innerText = db.userName;
    
    const total = db.expenses.reduce((s, a) => s + a.amount, 0);
    const percent = db.limit > 0 ? Math.min((total / db.limit) * 100, 100) : 0;
    
    const bar = document.getElementById('sidebarLimitBar');
    const pText = document.getElementById('sidebarLimitPercent');
    
    if (bar) bar.style.width = `${percent}%`;
    if (pText) pText.innerText = `${Math.round(percent)}%`;
}

function toggleMenu() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('menu-overlay');
    if (!sidebar) return;

    const isOpen = sidebar.classList.contains('open');
    if (!isOpen) {
        updateSidebarUI();
        sidebar.classList.add('open');
        sidebar.style.transform = "translateX(0)";
        overlay?.classList.add('active');
    } else {
        sidebar.classList.remove('open');
        sidebar.style.transform = "translateX(-100%)";
        overlay?.classList.remove('active');
    }
}

function toggleTheme() {
    const isLight = document.getElementById('theme-toggle').checked;
    if (isLight) {
        document.body.classList.add('light-theme');
        localStorage.setItem('f_pro_theme', 'light');
    } else {
        document.body.classList.remove('light-theme');
        localStorage.setItem('f_pro_theme', 'dark');
    }
}

function applySavedTheme() {
    const saved = localStorage.getItem('f_pro_theme');
    const toggle = document.getElementById('theme-toggle');
    if (saved === 'light' && toggle) {
        toggle.checked = true;
        document.body.classList.add('light-theme');
    }
}

// 8. DATA OPERATIONS
function submitExpense() {
    const amtInp = document.getElementById('inpAmount');
    const val = parseFloat(amtInp.value);
    if (isNaN(val) || val <= 0) return alert("Shuma e pavlefshme");

    db.expenses.unshift({
        amount: val,
        cat: document.getElementById('selectedCat').value || "Tjera",
        icon: document.getElementById('selectedIcon').value || "food",
        date: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    });

    saveAndSync();
    hideModal('addModal');
    amtInp.value = '';
    renderUI();
}

function saveAndSync() {
    localStorage.setItem('f_pro_v3', JSON.stringify(db.expenses));
    localStorage.setItem('f_pro_lim_v3', db.limit.toString());
}

function showLimitModal() {
    const n = prompt("Cakto limitin (€):", db.limit);
    if (n !== null && !isNaN(parseFloat(n))) {
        db.limit = parseFloat(n);
        saveAndSync();
        renderUI();
    }
}

function clearAll() {
    if(confirm("A jeni i sigurt? Të gjitha të dhënat do fshihen.")) {
        localStorage.clear();
        location.reload();
    }
}

// 9. AI & CHARTS INITIALIZATION
function initCharts() {
    const ctx = document.getElementById('appChart')?.getContext('2d');
    if (!ctx) return;
    db.charts.line = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['', '', '', '', '', ''],
            datasets: [{
                data: [0,0,0,0,0,0],
                borderColor: '#6366f1',
                borderWidth: 4,
                tension: 0.5,
                fill: true,
                backgroundColor: 'rgba(99, 102, 241, 0.05)'
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
    });
}

function updateFinancialIntelligence() {
    const statusEl = document.getElementById('auth-status-main');
    if (!statusEl) return;
    const total = db.expenses.reduce((s, a) => s + a.amount, 0);
    const usage = db.limit > 0 ? (total / db.limit) * 100 : 0;
    if (usage < 50) { statusEl.innerText = "Gjendje e Shkëlqyer"; statusEl.style.color = "#10b981"; }
    else if (usage < 85) { statusEl.innerText = "Kujdes me shpenzimet"; statusEl.style.color = "#f59e0b"; }
    else { statusEl.innerText = "Kritike!"; statusEl.style.color = "#ef4444"; }
}

function hideModal(id) { document.getElementById(id)?.classList.add('hidden'); }
function setCat(c, i, el) {
    document.querySelectorAll('.cat-card').forEach(x => x.classList.remove('border-indigo-500'));
    el.classList.add('border-indigo-500');
    document.getElementById('selectedCat').value = c;
    document.getElementById('selectedIcon').value = i;
}
</script>       
            
</body>
</html>











